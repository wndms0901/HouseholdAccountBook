<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.app.mapper.BudgetMapper">
    <resultMap type="com.app.dto.BudgetListDto" id="budgetListDto">
        <result column="large_category_id" property="largeCategoryId" />
        <result column="large_category_name" property="largeCategoryName" />
        <result column="expenditurebudget_id" property="expenditurebudgetId" />
        <result column="expenditure_budget_amount" property="expenditureBudgetAmount" />
        <result column="expenditure_budget_date" property="expenditureBudgetDate" />
        <result column="expenditure_amount" property="expenditureAmount" />
        <result column="total" property="total" />
    </resultMap>

    <select id="selectIncomeBudgetAmount" parameterType="com.app.dto.BudgetRequestDto" resultType="String">
        SELECT i.income_budget_amount
          FROM income_budget i
         WHERE i.income_budget_date =#{incomeBudgetDate}
           AND i.user_email=#{email}
    </select>
    <select id="selectThreeMonthAverageExpenditure" parameterType="com.app.dto.BudgetRequestDto" resultType="String">
        SELECT ROUND(AVG(e.total_expenditure))
          FROM (
                SELECT NVL(sum(e.card),0)+NVL(sum(e.cash),0) AS total_expenditure
                  FROM expenditure e
                 WHERE e.user_email=#{email}
                   AND LEFT(e.expenditure_date, 6) BETWEEN REPLACE(LEFT(DATE_ADD(now(),interval-3 month),8),"-","") AND REPLACE(LEFT(DATE_ADD(now(),interval-1 month),8),"-","")
              GROUP BY e.user_email, LEFT(e.expenditure_date, 6)
               ) e
    </select>
    <select id="selectLastMonthExpenditure" parameterType="com.app.dto.BudgetRequestDto" resultType="String">
        SELECT NVL(sum(e.card),0)+NVL(sum(e.cash),0)
        FROM expenditure e
        WHERE e.user_email=#{email}
        AND left(e.expenditure_date, 6) = replace(left(date_add(now(),interval-1 month),8),"-","")
   GROUP BY e.user_email
    </select>
    <select id="selectBudgetList" parameterType="com.app.dto.BudgetRequestDto" resultMap="budgetListDto">
             SELECT lc.large_category_id
                  , lc.large_category_name
                  , NVL(eb.expenditure_budget_amount,0) AS expenditure_budget_amount
                  , NVL(e.expenditure_amount,0) AS expenditure_amount
               FROM (
                     SELECT lc.large_category_id
                          , lc.large_category_name
                       FROM large_category lc
                      WHERE lc.category_type=#{categoryType}
                    ) lc
    LEFT OUTER JOIN (
                     SELECT eb.large_category_id
                          , eb.expenditure_budget_amount
                       FROM expenditure_budget eb
                      WHERE eb.user_email=#{email}
                        AND eb.expenditure_budget_date=#{expenditureBudgetDate}
                    ) eb
                 ON lc.large_category_id = eb.large_category_id
    LEFT OUTER JOIN (
                     SELECT e.large_category_id ,sum(e.card)+sum(e.cash) AS expenditure_amount
                       FROM expenditure e
                      WHERE e.user_email=#{email}
                        AND left(e.expenditure_date, 6)=#{expenditureBudgetDate}
                   GROUP BY e.large_category_id
                    ) e
                 ON lc.large_category_id = e.large_category_id
    </select>
    <select id="selectMonthBudgetExpenditureList" parameterType="com.app.dto.BudgetRequestDto" resultMap="budgetListDto">
        SELECT a.large_category_id
             , a.large_category_name
             , a.total
          FROM (
                SELECT et.large_category_id
                     , '합계' AS large_category_name
                     , ebt.total - et.total as total
                  FROM (
                        SELECT 0 AS large_category_id
                             , NVL(SUM(t.total),0) AS total
                          FROM (
                                SELECT e.large_category_id
                                     , SUM(e.card)+SUM(e.cash) AS total
                                  FROM expenditure e
                                 WHERE e.user_email=#{email}
                                   AND e.expenditure_date BETWEEN #{startDate} AND #{endDate}
                              GROUP BY e.large_category_id
                               ) t
                       ) et
    INNER JOIN (
                SELECT 0 AS large_category_id
                     , NVL(SUM(eb.expenditure_budget_amount),0) AS total
                  FROM expenditure_budget eb
                 WHERE eb.user_email=#{email}
                   AND eb.expenditure_budget_date = CONCAT(#{year},#{month})
               ) ebt
            ON et.large_category_id = ebt.large_category_id
     UNION ALL
        SELECT lc.large_category_id
             , lc.large_category_name
             , NVL(eb.expenditure_budget_amount,0) - NVL(e.total,0) AS total
          FROM (
                SELECT lc.large_category_id
                     , lc.large_category_name
                  FROM large_category lc
                 WHERE lc.category_type = 'EXP'
               ) lc
     LEFT JOIN (
                SELECT e.large_category_id
                     , SUM(e.card)+SUM(e.cash) AS total
                  FROM expenditure e
                 WHERE e.user_email=#{email}
                   AND e.expenditure_date BETWEEN #{startDate} AND #{endDate}
              GROUP BY e.large_category_id
               ) e
            ON lc.large_category_id = e.large_category_id
     LEFT JOIN (
                SELECT eb.large_category_id
                     , eb.expenditure_budget_amount
                  FROM expenditure_budget eb
                 WHERE eb.user_email=#{email}
                   AND eb.expenditure_budget_date = CONCAT(#{year},#{month})
               ) eb
            ON lc.large_category_id = eb.large_category_id
      ORDER BY FIELD(large_category_id,1), large_category_id
               ) a
    </select>
</mapper>